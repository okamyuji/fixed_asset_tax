# E2Eテストシナリオ（MECE準拠）

## 目的

固定資産税計算アプリケーションの全機能をPlaywrightでE2Eテストし、日本の税制に準拠しているかを検証する。

---

## MECEロジックツリー: E2Eテストシナリオ

```text
E2Eテストシナリオ
├── 1. 認証フロー（MECE）
│   ├── 1.1 ユーザー登録
│   ├── 1.2 ログイン
│   └── 1.3 ログアウト
│
├── 2. 資産管理フロー（MECE）
│   ├── 2.1 土地資産の登録
│   ├── 2.2 家屋資産の登録
│   └── 2.3 償却資産グループの登録
│
├── 3. 固定資産登録フロー（MECE）
│   ├── 3.1 機械装置の登録
│   ├── 3.2 減価償却ポリシーの設定
│   │   ├── 3.2.1 定額法
│   │   └── 3.2.2 定率法
│   └── 3.3 取得日・取得価額の設定
│
├── 4. 税額計算フロー（MECE）
│   ├── 4.1 計算の実行
│   ├── 4.2 計算結果の表示
│   └── 4.3 計算詳細の検証
│
└── 5. 日本の税制準拠検証（MECE）
    ├── 5.1 減価償却計算の正確性
    │   ├── 5.1.1 定額法の計算
    │   ├── 5.1.2 定率法（200%）の計算
    │   └── 5.1.3 固定資産税評価上の減価
    ├── 5.2 課税標準額の特例
    │   ├── 5.2.1 住宅用地の特例（1/6、1/3）
    │   └── 5.2.2 新築住宅の減額（3年間1/2）
    ├── 5.3 免税点の判定
    │   ├── 5.3.1 土地（30万円未満）
    │   ├── 5.3.2 家屋（20万円未満）
    │   └── 5.3.3 償却資産（150万円未満）
    └── 5.4 税率の適用
        └── 5.4.1 標準税率1.4%
```

---

## テストシナリオ詳細

### シナリオ1: 認証フロー

#### 1.1 ユーザー登録

- [ ] 新規ユーザー登録フォームにアクセス
- [ ] メールアドレス、パスワードを入力
- [ ] 登録ボタンをクリック
- [ ] ダッシュボードにリダイレクトされることを確認

#### 1.2 ログイン

- [ ] ログインフォームにアクセス
- [ ] 登録済みの認証情報を入力
- [ ] ログインボタンをクリック
- [ ] ダッシュボードに遷移することを確認

#### 1.3 ログアウト

- [ ] ログアウトボタンをクリック
- [ ] ログインページにリダイレクトされることを確認

---

### シナリオ2: 土地資産の登録と住宅用地特例の検証

#### 土地資産の登録と住宅用地特例の検証目的

住宅用地の課税標準の特例（1/6、1/3）が正しく適用されることを検証

#### テストケース2.1: 小規模住宅用地（200㎡以下）

1. **資産登録**
   - 資産名: 「テスト住宅用地A」
   - カテゴリ: 土地（land）
   - プロパティタイプ: 住宅用（residential）
   - 面積: 150㎡

2. **期待される計算結果**
   - 評価額: 150㎡ × 100,000円/㎡ = 15,000,000円
   - 課税標準額: 15,000,000円 × 1/6 = 2,500,000円
   - 税額: 2,500,000円 × 1.4% = 35,000円

3. **検証ポイント**
   - [ ] 計算結果画面で評価額が15,000,000円と表示される
   - [ ] 課税標準額が2,500,000円と表示される
   - [ ] 税額が35,000円と表示される

#### テストケース2.2: 一般住宅用地（200㎡超）

1. **資産登録**
   - 資産名: 「テスト住宅用地B」
   - 面積: 300㎡

2. **期待される計算結果**
   - 評価額: 30,000,000円
   - 課税標準額: (200㎡部分 × 1/6) + (100㎡部分 × 1/3) = 6,666,667円
   - 税額: 6,666,667円 × 1.4% = 93,333円

3. **検証ポイント**
   - [ ] 200㎡超の部分に1/3特例が適用される
   - [ ] 税額が正しく計算される

---

### シナリオ3: 新築住宅の減額特例の検証

#### テストケース3.1: 新築住宅（3年以内）

1. **資産登録**
   - 資産名: 「新築テスト住宅」
   - カテゴリ: 家屋（building）
   - 取得日: 2023年1月1日（2年前）
   - 取得価額: 10,000,000円

2. **期待される計算結果**
   - 評価額: 固定資産税評価額（減価後）
   - 課税標準額: 評価額 × 1/2（新築減額適用）
   - 税額: 課税標準額 × 1.4%

3. **検証ポイント**
   - [ ] 課税標準額が評価額の1/2になっている
   - [ ] 新築減額が適用されている旨が表示される

---

### シナリオ4: 免税点の判定検証

#### テストケース4.1: 土地（免税点未満）

1. **資産登録**
   - 面積: 2㎡（評価額200,000円）

2. **期待される結果**
   - 税額: 0円
   - 免税理由: "Below exemption threshold"

3. **検証ポイント**
   - [ ] 税額が0円と表示される
   - [ ] 免税点未満である旨が表示される

#### テストケース4.2: 償却資産（免税点未満）

1. **資産登録**
   - 取得価額: 1,000,000円（免税点1,500,000円未満）

2. **期待される結果**
   - 税額: 0円

---

### シナリオ5: 定率法（200%）の正確性検証

#### テストケース5.1: 初年度の定率法計算

1. **固定資産登録**
   - 取得価額: 10,000,000円
   - 取得日: 2025年1月1日（当年）
   - 耐用年数: 10年
   - 減価償却方法: 定率法（declining_balance）

2. **期待される固定資産税評価額**
   - 減価率: 0.206（耐用年数10年）
   - 初年度評価額: 10,000,000 × (1 - 0.206 × 0.5) = 8,970,000円

3. **検証ポイント**
   - [ ] 評価額が8,970,000円前後である
   - [ ] 初年度の半年償却が適用されている

#### テストケース5.2: 2年目の定率法計算

1. **前提条件**
   - 前年度評価額: 8,970,000円

2. **期待される計算結果**
   - 2年目評価額: 8,970,000 × (1 - 0.206) = 7,122,180円

---

### シナリオ6: エンドツーエンド総合シナリオ

#### フルフロー: 資産登録から税額計算まで

1. **ユーザー登録・ログイン**
   - 新規ユーザーを作成
   - ログイン

2. **複数資産の登録**
   - 土地資産（住宅用地、150㎡）
   - 家屋資産（新築、10,000,000円）
   - 償却資産（機械装置、5,000,000円、定率法）

3. **税額計算の実行**
   - 計算を実行
   - 結果画面に遷移

4. **結果の検証**
   - [ ] 3つの資産がすべて表示される
   - [ ] 各資産の税額が正しく計算されている
   - [ ] 合計税額が正しく表示される
   - [ ] 特例・減額が適用されている資産が明示される
   - [ ] 免税点未満の資産は税額0円である

---

## テスト実行チェックリスト

### 事前準備

- [ ] Docker環境が起動している
- [ ] データベースがマイグレーション済み
- [ ] フロントエンド（Vite）が起動している
- [ ] バックエンドAPIが正常に動作している

### 実行項目

- [ ] 認証フロー（3ケース）
- [ ] 住宅用地特例（2ケース）
- [ ] 新築住宅減額（1ケース）
- [ ] 免税点判定（3ケース）
- [ ] 定率法計算（2ケース）
- [ ] エンドツーエンド総合シナリオ（1ケース）

### 合計: 12テストケース

---

## 期待される結果

すべてのテストケースがPASSすることで、以下が保証される:

1. ✅ 日本の固定資産税法に準拠した正確な計算
2. ✅ 住宅用地の課税標準特例の正しい適用
3. ✅ 新築住宅の減額特例の正しい適用
4. ✅ 免税点の正しい判定
5. ✅ 定率法（200%）の正確な計算
6. ✅ 固定資産税評価上の減価計算の正確性
7. ✅ ユーザーインターフェースの正常動作
8. ✅ エンドツーエンドのデータフローの整合性

---

## テスト実行コマンド

```bash
# Playwrightテストの実行
cd frontend
npx playwright test

# 特定のテストのみ実行
npx playwright test e2e/fixed-asset-tax-calculation.spec.ts

# UIモードで実行（デバッグ用）
npx playwright test --ui

# ヘッドフルモードで実行（ブラウザを表示）
npx playwright test --headed
```
